---
title: "Env-Chem_Gen-Code"
author: "J.Behrens"
date: "11/30/2020"
output: html_document
---

# Set-Up R Environment
```{r setup}
## Clear environment
rm(list = ls())

## Libraries
library(dataRetrieval)
library(tidyverse)
library(openxlsx)
library(leaflet)                                           
library(reshape2)
library(knitr)

#Set working directory
opts_knit$set(root.dir = "C:/Users/jbehr/OneDrive - Duke University/Documents/5. R/General_Env_Chem")
```

# Download Data

For now, just looking at organic contaminants on the USGS PCode List (NWIS).

```{r}
# Import Raw Data
USGS_Param<-read.csv("raw_data/RAW_USGS-Param-Codes.csv") %>% 
  mutate(casrn = str_replace_all(casrn, "-","")) 

Lists_CompTox_raw<-read.csv("raw_data/CompToxChemicalsDashboard-Batch-Search_2020-11-30.csv")

Chem_CompTox_raw<-read.csv("raw_data/RAW_CompToxChemicalsDashboard-All-USGS-PCs.csv") %>% 
  mutate(CASRN = str_replace_all(CASRN, "-",""))

TSCA_List<-read.csv("raw_data/TSCAINV_062020.csv") %>% 
  filter(ACTIVITY == "ACTIVE") %>% 
  distinct(casregno, .keep_all = TRUE)
List_Names_CompTox<-read.csv("raw_data/CompTox_Lists.csv")

# Make a few simiple datsets
All_CompTox_Data<-left_join(Lists_CompTox_raw, Chem_CompTox_raw, by="DTXSID") %>% 
  filter(DTXSID !="-")

Lists_CompTox<- Lists_CompTox_raw %>% 
  gather(LISTS, Yes_or_No, 6:293) %>% 
  filter(Yes_or_No == "Y") %>% 
  select(!Yes_or_No) %>% #These three lines consolidates the lists, and removes categories the cmpd is not in
  arrange(-desc(PREFERRED_NAME)) %>% 
  left_join(List_Names_CompTox)

```

# Merge Datasets
```{r}
# Count of compounds, by list
Lists_CompTox %>% 
  group_by(LISTS) %>%   
  count() %>%
  full_join(List_Names_CompTox) %>% 
  arrange(desc(n))

# Count of compounds, by category
Categories<-Lists_CompTox %>%
  filter(Gen_Type == "Category") %>%
  distinct(PREFERRED_NAME, .keep_all = TRUE)

Categories %>% 
  group_by(Specific_Type) %>% 
  count() %>% 
  arrange(desc(n))


USGS_Param %>% 
  group_by(parameter_group_nm) %>% 
  count() %>% 
  arrange(desc(n))

```

#Some simple stats
```{r}
# Find uncategorized chemicals














full_PFAS<-Categories %>% 
  filter(Specific_Type == "PFAS") %>% 
  view()


Full_new<-left_join(Lists_CompTox, 
                select(Chem_CompTox_raw, c(DTXSID,CASRN)), 
                by="DTXSID")
  
  
All<-full_join(USGS_Param, Lists_CompTox)





full_1<-USGS_Param %>%   
  group_by(parameter_group_nm) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  view()
  filter(!str_detect(parameter_group_nm, 
                    "inorganic")) 





USGS<-USGS_Param %>% 
  distinct(casrn, .keep_all = )



```



# Plot: By Decade

```{r}

#OLD CODE

Year_Plot<- Both_Water %>% 
  ggplot(aes(x=as.character(Decade), fill=Site_Group)) +
  geom_bar() +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) + 
  labs(title="Both Areas by Decade")
print(Year_Plot)
##ggsave("output/Years.png")

Year_4_site_Plot<- Both_Water  %>% 
  filter(str_detect(MonitoringLocationIdentifier, 
                    "USGS-02085500|USGS-02086500|USGS-02086849|J1269000")) %>% 
  ggplot(aes(x=as.character(Decade), fill=MonitoringLocationName)) +
  geom_bar() +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) + 
  labs(title="Both Areas by Decade")
print(Year_4_site_Plot)
##ggsave("output/Years_4_sites.png")

decade_EC_Plot<-Ellerbe_Creek_Water %>% 
  ggplot(aes(x=MonitoringLocationIdentifier, fill = as.character(Decade))) +
  geom_bar() +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) + 
  labs(title="Ellerbe Creek by Decade")
print(decade_EC_Plot)
##ggsave("output/Decades_EC.png")

decade_FR_Plot<-Flat_River_Water %>% 
  ggplot(aes(x=MonitoringLocationIdentifier, fill = as.character(Decade))) +
  geom_bar() +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) + 
  labs(title="Flat River by Decade")
print(decade_FR_Plot)
##ggsave("output/Decades_FR.png")
```